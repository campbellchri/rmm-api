name: Deploy API to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:

env:
  GCP_REGION: us-central1
  SERVICE_NAME: rmm-api-staging
  REPOSITORY: rmm-docker
  IMAGE_NAME: rmm-api
  CLOUD_SQL_INSTANCE: remember-me-memorials-llc:us-central1:rmm-postgres

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and push Docker image
        run: |
          IMAGE_TAG=${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:staging-${{ github.sha }}
          
          docker build \
            --platform linux/amd64 \
            -t $IMAGE_TAG .
          
          docker push $IMAGE_TAG

      - name: Deploy to Cloud Run
        run: |
          IMAGE_TAG=${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:staging-${{ github.sha }}
          
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image $IMAGE_TAG \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 2 \
            --min-instances 1 \
            --max-instances 10 \
            --service-account 33219909686-compute@developer.gserviceaccount.com \
            --set-env-vars NODE_ENV=production \
            --set-env-vars BASE_PATH=/api \
            --set-env-vars DB_HOST="/cloudsql/remember-me-memorials-llc:us-central1:rmm-postgres" \
            --set-env-vars DB_PORT="${{ secrets.DB_PORT }}" \
            --set-env-vars DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            --set-env-vars DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --set-env-vars DB_DATABASE="${{ secrets.DB_DATABASE }}" \
            --set-env-vars DB_SYNCHRONIZE=false \
            --set-env-vars JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --set-env-vars JWT_EXPIRES_IN=7d \
            --set-env-vars FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}" \
            --set-env-vars FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}" \
            --set-env-vars FIREBASE_CLIENT_EMAIL="${{ secrets.FIREBASE_CLIENT_EMAIL }}" \
            --set-env-vars ENABLE_SWAGGER=true \
            --add-cloudsql-instances ${{ env.CLOUD_SQL_INSTANCE }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --format 'value(status.url)')
          
          echo "üöÄ API deployed to: $SERVICE_URL"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

      - name: Verify deployment
        run: |
          echo "Checking deployment health..."
          sleep 15
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.SERVICE_URL }}/api")
          
          if [ $HTTP_CODE -eq 200 ] || [ $HTTP_CODE -eq 201 ]; then
            echo "‚úÖ Deployment successful! API is responding."
          else
            echo "‚ö†Ô∏è Deployment may have issues. HTTP response code: $HTTP_CODE"
            echo "Checking logs..."
            gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.SERVICE_NAME }}" \
              --limit 50 \
              --project ${{ secrets.GCP_PROJECT_ID }} \
              --format json
            exit 1
          fi